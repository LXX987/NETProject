@page "/shopAddProduct"
@layout ShopLayout
@using BlazorApp.Data
@using System.ComponentModel.DataAnnotations;
@using System.Text.Json;
@using System.ComponentModel
@using BlazorApp.Service
@inject NavigationManager NavigationManager
@inject CommodityApiClient CommodityService
@inject Blazored.SessionStorage.ISessionStorageService sessionStorage
<h3>ShopAddProduct</h3>
上传商品图片：
<Upload Action="https://www.mocky.io/v2/5cc8019d300000980a055e76"
        Name="files"
        OnSingleCompleted="OnSingleCompleted">
    <Button Icon="upload">
        <span>Click to Upload</span>
    </Button>
</Upload>
<Form Model="@model"
        OnFinish="OnFinish"
        OnFinishFailed="OnFinishFailed"
        LabelColSpan="8"
        WrapperColSpan="16">
    <FormItem Label="商品名称">
        <Input @bind-Value="@context.Name" />
    </FormItem>
    <FormItem Label="商品价格">
        <Input @bind-Value="@context.Price" />
    </FormItem>
    <FormItem Label="商品数量">
        <Input @bind-Value="@context.Num" />
    </FormItem>
    <FormItem Label="团购开始时间">
        <DatePicker @bind-Value="@context.StartTime" TValue="DateTime?" ShowTime="@true" OnChange="OnChange" />
    </FormItem>
    <FormItem Label="团购结束时间">
        <DatePicker @bind-Value="@context.EndTime" TValue="DateTime?" ShowTime="@true" OnChange="OnChange" />
    </FormItem>
    <FormItem WrapperColOffset="8" WrapperColSpan="16">
        <Button Type="@ButtonType.Primary" HtmlType="submit" @onclick="addProduct">
            发布
        </Button>
    </FormItem>
</Form>

@code {
    public class Model
    {
        [Required, DisplayName("User Name")]
        public string Name { get; set; }
        [Required]
        public int Price { get; set; }
        [Required]
        public int Num { get; set; }
        [Required]
        public DateTime? StartTime { get; set; } = DateTime.Now;
        [Required]
        public DateTime? EndTime { get; set; } = DateTime.Now;
    }

    private Model model = new Model();

    private void OnFinish(EditContext editContext)
    {
        Console.WriteLine($"Success:{JsonSerializer.Serialize(model)}");
    }

    private void OnFinishFailed(EditContext editContext)
    {
        Console.WriteLine($"Failed:{JsonSerializer.Serialize(model)}");
    }

    protected async void addProduct()
    {
        var token = await sessionStorage.GetItemAsync<string>("token");
        string start = model.StartTime.ToString();
        string end=model.EndTime.ToString();
        int a = await CommodityService.addProduct(model.Price,model.Num,model.Name,start,end ,token);
        Console.WriteLine($"addProduct:{JsonSerializer.Serialize(model)}");
    }

    private void OnChange(DateTimeChangedEventArgs args)
    {
        Console.WriteLine($"Selected Time: {args.Date}");
        Console.WriteLine($"Formatted Selected Time: {args.DateString}");
    }

    void OnSingleCompleted(UploadInfo fileinfo)
    {
        if (fileinfo.File.State == UploadState.Success)
        {
            var result = fileinfo.File.GetResponse<ResponseModel>();
            fileinfo.File.Url = result.url;
        }
    }

    public class ResponseModel
    {
        public string name { get; set; }

        public string status { get; set; }

        public string url { get; set; }

        public string thumbUrl { get; set; }
    }

}
